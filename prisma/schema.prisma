// The.Cafe AI Agent Platform - Database Schema

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Agent - Core AI agents with multi-model support
model Agent {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Identity
  name        String   // Format: [Role] - [Specialization]
  emoji       String   @default("ü§ñ")
  description String?

  // Classification
  domain      String   // e.g., "marketing", "engineering", "design"
  subCategory String?  // e.g., "strategy", "copywriting"
  archetype   String?  // e.g., "strategist", "analyst", "creator"

  // AI Model Configuration
  defaultModel     String   // e.g., "claude-sonnet-4", "gpt-4", "gemini-pro"
  alternativeModels String[] // Available alternative models
  systemPrompt     String   @db.Text
  temperature      Float    @default(0.7)
  maxTokens        Int      @default(4096)

  // Metadata
  capabilities Json     // Array of capability strings
  tags        Json     // Array of tag strings
  customMetadata Json?  // Flexible additional data

  // Organization
  projects    ProjectAgent[]
  conversations Conversation[]

  // Auto-generation tracking
  autoGenerated Boolean @default(false)
  sourceAnalysis String? @db.Text // Topic analysis that created this agent

  @@index([domain])
  @@index([archetype])
}

// Project - Collections of agents for specific initiatives
model Project {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  name        String
  description String?
  emoji       String   @default("üìÅ")
  color       String   @default("#8b4049") // The.Cafe burgundy

  agents      ProjectAgent[]
  conversations Conversation[]

  @@index([createdAt])
}

// Join table for many-to-many Agent <-> Project
model ProjectAgent {
  id        String   @id @default(cuid())
  agentId   String
  projectId String
  addedAt   DateTime @default(now())

  agent     Agent   @relation(fields: [agentId], references: [id], onDelete: Cascade)
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([agentId, projectId])
  @@index([projectId])
  @@index([agentId])
}

// Conversation - Chat sessions with agents
model Conversation {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  title       String   @default("New Conversation")

  // Agent & Project relationship
  agentId     String
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  // Current AI model being used
  currentModel String  // Can switch mid-conversation

  // Topic Analysis
  detectedTopic String?
  suggestedAgents Json? // Array of suggested agent IDs with reasoning
  detectedGaps   Json?  // Array of missing agent suggestions

  messages    Message[]

  @@index([agentId])
  @@index([projectId])
  @@index([createdAt])
}

// Message - Individual messages in conversations
model Message {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role           String   // "user", "assistant", "system"
  content        String   @db.Text

  // Model tracking - which model generated this response
  modelUsed      String?  // e.g., "claude-sonnet-4"
  tokensUsed     Int?

  metadata       Json?    // For tool calls, function results, etc.

  @@index([conversationId])
  @@index([createdAt])
}
